name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint and format check
        run: npm run lint


      - name: Verify manifest and icons
        run: |
          node -e "const fs=require('fs');const m=JSON.parse(fs.readFileSync('manifest.json','utf8'));if(!m.name||!m.version||!m.manifest_version){throw new Error('manifest missing required fields');}if(!m.icons){throw new Error('manifest missing icons');}const icons=m.icons;['16','32','48','128'].forEach(s=>{if(!icons[s]){throw new Error('missing icon size '+s);}if(!fs.existsSync(icons[s])){throw new Error('icon file missing: '+icons[s]);}});console.log('manifest ok');"

      - name: Create extension zip
        run: |
          zip -r extension.zip . \
            -x ".git/*" ".github/*" ".agent/*" "node_modules/*"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-zip
          path: extension.zip
